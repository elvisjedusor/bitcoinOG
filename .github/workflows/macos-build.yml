name: macOS Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    name: macOS Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-latest
          - arch: x86_64
            runner: macos-15-intel

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install boost berkeley-db@4 openssl@3 wxwidgets

    - name: Verify dependencies
      run: |
        brew list boost berkeley-db@4 openssl@3 wxwidgets
        wx-config --version

    - name: Build native binaries
      run: |
        make -f makefile.osx clean
        make -f makefile.osx all

    - name: Verify binaries
      run: |
        echo "=== bitokd info ==="
        file bitokd
        otool -L bitokd
        ./bitokd -? || echo "Daemon test OK"
        echo ""
        echo "=== bitok info ==="
        file bitok
        otool -L bitok

    - name: Bundle dependencies
      run: |
        # Get Homebrew prefix
        BREW_PREFIX=$(brew --prefix)

        echo "=== Bundling OpenSSL libraries ==="
        mkdir -p libs
        cp "${BREW_PREFIX}/opt/openssl@3/lib/libssl.3.dylib" libs/
        cp "${BREW_PREFIX}/opt/openssl@3/lib/libcrypto.3.dylib" libs/

        echo "=== Checking wxWidgets dependencies ==="
        # wxWidgets may have additional dependencies that need bundling
        # We'll check what bitok links to and bundle those as well
        otool -L bitok | grep -E "wx|boost" | awk '{print $1}' | while read lib; do
          if [ -f "$lib" ]; then
            echo "Bundling: $lib"
            cp "$lib" libs/ 2>/dev/null || true
          fi
        done

        # Fix library paths in the bundled libraries themselves
        echo "=== Fixing bundled library IDs ==="
        for lib in libs/*.dylib; do
          if [ -f "$lib" ]; then
            libname=$(basename "$lib")
            echo "Fixing ID for: $libname"
            install_name_tool -id "@rpath/$libname" "$lib" 2>/dev/null || true
          fi
        done

        # Fix inter-library dependencies in bundled libs
        install_name_tool -change "${BREW_PREFIX}/opt/openssl@3/lib/libcrypto.3.dylib" "@rpath/libcrypto.3.dylib" libs/libssl.3.dylib 2>/dev/null || true

        # Fix paths in bitokd
        echo "=== Fixing bitokd library references ==="
        install_name_tool -change "${BREW_PREFIX}/opt/openssl@3/lib/libssl.3.dylib" "@rpath/libssl.3.dylib" bitokd 2>/dev/null || true
        install_name_tool -change "${BREW_PREFIX}/opt/openssl@3/lib/libcrypto.3.dylib" "@rpath/libcrypto.3.dylib" bitokd 2>/dev/null || true

        # Fix paths in bitok - handle all homebrew libraries
        echo "=== Fixing bitok library references ==="
        otool -L bitok | grep "${BREW_PREFIX}" | awk '{print $1}' | while read lib; do
          libname=$(basename "$lib")
          echo "  Rewriting: $lib -> @rpath/$libname"
          install_name_tool -change "$lib" "@rpath/$libname" bitok 2>/dev/null || true
        done

        echo "=== Verifying bitokd dependencies ==="
        otool -L bitokd

        echo "=== Verifying bitok dependencies ==="
        otool -L bitok

    - name: Strip binaries
      run: |
        strip bitokd
        strip bitok
        strip libs/*.dylib

    - name: Create .app bundle
      run: |
        make -f makefile.osx bundle

        # Bundle libraries with .app
        mkdir -p Bitok.app/Contents/Frameworks
        cp libs/*.dylib Bitok.app/Contents/Frameworks/

        # Fix rpath in app bundle binary
        install_name_tool -add_rpath "@executable_path/../Frameworks" Bitok.app/Contents/MacOS/bitok 2>/dev/null || true

        echo "=== Verifying app bundle binary ==="
        otool -L Bitok.app/Contents/MacOS/bitok

    - name: Create release packages
      run: |
        # Version info
        VERSION="0.3.19"
        ARCH=$(uname -m)

        # Create README for daemon
        cat > README-DAEMON.txt << 'EOF'
        Bitok v0.3.19 - macOS Daemon
        ============================

        QUICK START
        -----------
        1. Extract the archive:
           tar -xzf bitokd-*.tar.gz
           cd bitokd-*

        2. Run daemon:
           ./bitokd -daemon

        3. Check status:
           ./bitokd getinfo

        4. Stop daemon:
           ./bitokd stop

        PACKAGE CONTENTS
        ----------------
        - bitokd: The daemon binary
        - libs/: Required OpenSSL libraries (bundled)
        - README.txt: This file
        - license.txt: MIT License

        IMPORTANT
        ---------
        Keep the 'libs' folder in the same directory as 'bitokd'.
        The daemon will automatically find the bundled libraries.

        DATA LOCATION
        -------------
        Data directory: ~/Library/Application Support/Bitok/
        Config: ~/Library/Application Support/Bitok/bitok.conf

        VERIFY YOUR DOWNLOAD
        ---------------------
        Always verify checksums before running.

        Target: macOS 11.0+
        License: MIT
        EOF

        # Create README for GUI
        cat > README-GUI.txt << 'EOF'
        Bitok v0.3.19 - macOS GUI Wallet
        =================================

        QUICK START
        -----------
        Option 1 - Run .app bundle:
          1. Copy Bitok.app to /Applications
          2. Open from Applications folder

        Option 2 - Run binary directly:
          ./bitok

        DATA LOCATION
        -------------
        Wallet: ~/Library/Application Support/Bitok/wallet.dat

        IMPORTANT: Backup wallet.dat regularly!

        Target: macOS 11.0+
        License: MIT
        EOF

        # Create daemon package directory with proper structure
        DAEMON_DIR="bitokd-${VERSION}-macos-${ARCH}"
        mkdir -p "${DAEMON_DIR}/libs"
        cp bitokd "${DAEMON_DIR}/"
        cp libs/*.dylib "${DAEMON_DIR}/libs/"
        cp README-DAEMON.txt "${DAEMON_DIR}/README.txt"
        cp license.txt "${DAEMON_DIR}/"

        # Create daemon tarball with bundled libraries
        tar -czf "${DAEMON_DIR}.tar.gz" "${DAEMON_DIR}"

        # Create GUI package directory
        GUI_DIR="bitok-${VERSION}-macos-${ARCH}"
        mkdir -p "${GUI_DIR}"
        cp -r Bitok.app "${GUI_DIR}/"
        cp README-GUI.txt "${GUI_DIR}/README.txt"
        cp license.txt "${GUI_DIR}/"

        # Create GUI tarball (with .app bundle)
        tar -czf "${GUI_DIR}.tar.gz" "${GUI_DIR}"

        # Generate checksums
        shasum -a 256 "${DAEMON_DIR}.tar.gz" > "${DAEMON_DIR}.tar.gz.sha256"
        shasum -a 256 "${GUI_DIR}.tar.gz" > "${GUI_DIR}.tar.gz.sha256"

        # Create master checksums file
        cat > CHECKSUMS-MACOS.txt << EOF
        Bitok v${VERSION} - macOS Release Checksums
        ============================================

        Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Platform: macOS 11.0+ (${ARCH})

        Verify with:
          shasum -a 256 -c CHECKSUMS-MACOS.txt

        SHA-256 Checksums:
        ==================

        EOF

        # Add checksums to master file
        shasum -a 256 ${DAEMON_DIR}.tar.gz >> CHECKSUMS-MACOS.txt
        shasum -a 256 ${GUI_DIR}.tar.gz >> CHECKSUMS-MACOS.txt

        # Display results
        echo ""
        echo "========================================="
        echo "âœ“ macOS Release Packages Created (${ARCH})"
        echo "========================================="
        ls -lh ${DAEMON_DIR}.tar.gz
        ls -lh ${GUI_DIR}.tar.gz
        echo ""
        cat CHECKSUMS-MACOS.txt

    - name: Upload daemon package
      uses: actions/upload-artifact@v4
      with:
        name: bitokd-macos-${{ matrix.arch }}
        path: |
          bitokd-0.3.19-macos-*.tar.gz
          bitokd-0.3.19-macos-*.tar.gz.sha256

    - name: Upload GUI package
      uses: actions/upload-artifact@v4
      with:
        name: bitok-macos-${{ matrix.arch }}
        path: |
          bitok-0.3.19-macos-*.tar.gz
          bitok-0.3.19-macos-*.tar.gz.sha256

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums-macos-${{ matrix.arch }}
        path: CHECKSUMS-MACOS.txt
