name: macOS Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    name: macOS Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-latest
          - arch: x86_64
            runner: macos-15-intel

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install boost berkeley-db@4 openssl@3 wxwidgets jpeg-turbo webp giflib xz zstd libpng libtiff pcre2

    - name: Verify dependencies
      run: |
        brew list boost berkeley-db@4 openssl@3 wxwidgets jpeg-turbo webp giflib xz zstd libpng libtiff pcre2
        wx-config --version
        ls -la $(brew --prefix)/opt/jpeg-turbo/lib/ || true

    - name: Build native binaries
      run: |
        echo "=== Building with mining optimizations ==="
        echo "Compiler: -O3 -fomit-frame-pointer -march=native"
        echo "Yespower: -O3 -funroll-loops -ftree-vectorize"
        echo "Features: Pre-allocated contexts, CPU affinity"
        echo ""
        make -f makefile.osx clean
        make -f makefile.osx all

    - name: Verify binaries built
      run: |
        echo "=== bitokd info ==="
        file bitokd
        otool -L bitokd
        echo ""
        echo "=== bitok info ==="
        file bitok
        otool -L bitok

    - name: Bundle and sign daemon
      run: |
        set -e
        BREW_PREFIX=$(brew --prefix)
        echo "Homebrew prefix: $BREW_PREFIX"

        mkdir -p libs

        echo "=== Copying OpenSSL libraries ==="
        cp "${BREW_PREFIX}/opt/openssl@3/lib/libssl.3.dylib" libs/
        cp "${BREW_PREFIX}/opt/openssl@3/lib/libcrypto.3.dylib" libs/

        echo "=== Copying Berkeley DB libraries ==="
        for dblib in "$BREW_PREFIX"/opt/berkeley-db@4/lib/libdb*.dylib; do
          if [ -f "$dblib" ] && [ ! -L "$dblib" ]; then
            libname=$(basename "$dblib")
            echo "Copying: $libname"
            cp -f "$dblib" libs/
          fi
        done

        echo "=== Copying Boost libraries ==="
        for boostlib in "$BREW_PREFIX"/opt/boost/lib/libboost*.dylib; do
          if [ -f "$boostlib" ] && [ ! -L "$boostlib" ]; then
            libname=$(basename "$boostlib")
            echo "Copying: $libname"
            cp -f "$boostlib" libs/
          fi
        done

        echo "=== Copying ICU4C libraries ==="
        ICU_PATH=""
        for icu_dir in "$BREW_PREFIX"/opt/icu4c@*/lib "$BREW_PREFIX"/opt/icu4c/lib; do
          if [ -d "$icu_dir" ]; then
            ICU_PATH="$icu_dir"
            break
          fi
        done

        if [ -n "$ICU_PATH" ]; then
          echo "Found ICU at: $ICU_PATH"
          for iculib in "$ICU_PATH"/libicu*.dylib; do
            if [ -f "$iculib" ] && [ ! -L "$iculib" ]; then
              libname=$(basename "$iculib")
              if [[ "$libname" =~ ^(libicu[a-z0-9]+\.[0-9]+)\.[0-9]+\.dylib$ ]]; then
                short_name="${BASH_REMATCH[1]}.dylib"
                echo "Copying: $libname as $short_name"
                cp -f "$iculib" "libs/$short_name"
              else
                echo "Copying: $libname"
                cp -f "$iculib" libs/
              fi
            fi
          done
        fi

        echo "=== Copying compression libraries ==="
        for comp_pkg in xz zstd; do
          comp_path="$BREW_PREFIX/opt/$comp_pkg/lib"
          if [ -d "$comp_path" ]; then
            for complib in "$comp_path"/*.dylib; do
              if [ -f "$complib" ] && [ ! -L "$complib" ]; then
                libname=$(basename "$complib")
                echo "Copying: $libname"
                cp -f "$complib" libs/
              fi
            done
          fi
        done

        chmod -R u+w libs/

        echo "=== Fixing library IDs ==="
        for dylib in libs/*.dylib; do
          if [ -f "$dylib" ]; then
            libname=$(basename "$dylib")
            echo "Setting ID: $libname"
            install_name_tool -id "@rpath/$libname" "$dylib"
          fi
        done

        echo "=== Fixing inter-library dependencies ==="

        fix_lib_deps() {
          local target="$1"
          local target_name=$(basename "$target")

          deps=$(otool -L "$target" 2>/dev/null | tail -n +2 | awk '{print $1}')

          for dep in $deps; do
            dep_name=$(basename "$dep")

            if [[ "$dep" == /opt/homebrew/* ]] || [[ "$dep" == /usr/local/* ]]; then
              if [ -f "libs/$dep_name" ]; then
                echo "  $target_name: $dep -> @rpath/$dep_name"
                install_name_tool -change "$dep" "@rpath/$dep_name" "$target" 2>/dev/null || true
              else
                for candidate in libs/*.dylib; do
                  cand_name=$(basename "$candidate")
                  if [[ "$cand_name" == "${dep_name%.*}"* ]] || [[ "$dep_name" == "${cand_name%.*}"* ]]; then
                    echo "  $target_name: $dep -> @rpath/$cand_name (matched)"
                    install_name_tool -change "$dep" "@rpath/$cand_name" "$target" 2>/dev/null || true
                    break
                  fi
                done
              fi
            fi
          done
        }

        echo "Fixing dependencies in bundled libraries..."
        for pass in 1 2 3; do
          echo "Pass $pass..."
          for dylib in libs/*.dylib; do
            if [ -f "$dylib" ]; then
              fix_lib_deps "$dylib"
            fi
          done
        done

        echo "=== Fixing bitokd references ==="
        fix_lib_deps bitokd

        install_name_tool -add_rpath "@executable_path/libs" bitokd 2>/dev/null || true

        echo "=== Checking for remaining Homebrew paths ==="
        echo "In bitokd:"
        otool -L bitokd | grep -E "/opt/homebrew|/usr/local" || echo "  None found"

        echo "In libs:"
        for dylib in libs/*.dylib; do
          remaining=$(otool -L "$dylib" 2>/dev/null | grep -E "/opt/homebrew|/usr/local" || true)
          if [ -n "$remaining" ]; then
            echo "  $(basename $dylib): $remaining"
          fi
        done

        echo ""
        echo "=== SIGNING (must happen AFTER all install_name_tool changes) ==="
        echo "Signing bundled libraries..."
        for dylib in libs/*.dylib; do
          if [ -f "$dylib" ]; then
            echo "Signing: $(basename $dylib)"
            codesign --force --sign - "$dylib"
          fi
        done

        echo "Signing bitokd..."
        codesign --force --sign - bitokd

        echo "Verifying signatures..."
        codesign --verify --verbose bitokd || echo "Warning: signature verification issue"

        echo ""
        echo "=== Bundled daemon libraries ==="
        ls -la libs/

    - name: Test daemon (post-signing)
      run: |
        set -e
        echo "========================================="
        echo "DAEMON VERIFICATION (after signing)"
        echo "========================================="

        echo ""
        echo "=== Checking bitokd dependencies ==="
        otool -L bitokd

        echo ""
        echo "=== Verifying @rpath libraries exist ==="
        RPATH_LIBS=$(otool -L bitokd | grep "@rpath" | awk '{print $1}' | sed 's/@rpath\///' || true)
        MISSING=0
        for lib in $RPATH_LIBS; do
          if [ ! -f "libs/$lib" ]; then
            echo "MISSING: libs/$lib"
            MISSING=1
          else
            echo "OK: libs/$lib"
          fi
        done

        if [ "$MISSING" -eq 1 ]; then
          echo "ERROR: Missing required libraries!"
          exit 1
        fi

        echo ""
        echo "=== Testing bitokd execution ==="
        if ./bitokd --help 2>&1 | head -5; then
          echo ""
          echo "SUCCESS: bitokd runs correctly"
        else
          echo "ERROR: bitokd failed to run"
          echo ""
          echo "Debug with DYLD_PRINT_LIBRARIES:"
          DYLD_PRINT_LIBRARIES=1 ./bitokd --help 2>&1 | head -20 || true
          exit 1
        fi

        echo ""
        echo "=== Testing from different directory ==="
        ORIG_DIR=$(pwd)
        if (cd /tmp && "$ORIG_DIR/bitokd" --help 2>&1 | head -2); then
          echo "SUCCESS: Works from different directory"
        else
          echo "WARNING: Must run from install directory"
        fi

        echo ""
        echo "========================================="
        echo "DAEMON VERIFICATION PASSED"
        echo "========================================="

    - name: Strip binaries
      run: |
        strip bitokd || true
        strip bitok || true
        for dylib in libs/*.dylib; do
          codesign --force --sign - "$dylib" 2>/dev/null || true
        done
        codesign --force --sign - bitokd
        codesign --force --sign - bitok

    - name: Create .app bundle
      run: |
        set -e
        shopt -s nullglob

        BREW_PREFIX=$(brew --prefix)
        echo "Homebrew prefix: $BREW_PREFIX"

        make -f makefile.osx bundle

        mkdir -p Bitok.app/Contents/Frameworks
        chmod -R u+w Bitok.app/Contents/Frameworks/ 2>/dev/null || true

        cp -f libs/*.dylib Bitok.app/Contents/Frameworks/

        echo "=== Copying wxWidgets libraries ==="
        for wxlib in "$BREW_PREFIX"/opt/wxwidgets/lib/libwx*.dylib; do
          if [ -f "$wxlib" ] && [ ! -L "$wxlib" ]; then
            libname=$(basename "$wxlib")
            echo "Copying: $libname"
            cp -f "$wxlib" Bitok.app/Contents/Frameworks/
          fi
        done

        for wxlib in "$BREW_PREFIX"/opt/wxwidgets/lib/libwx*.dylib; do
          if [ -L "$wxlib" ]; then
            resolved=$(readlink -f "$wxlib" 2>/dev/null || greadlink -f "$wxlib" 2>/dev/null || echo "")
            if [ -f "$resolved" ]; then
              libname=$(basename "$resolved")
              if [ ! -f "Bitok.app/Contents/Frameworks/$libname" ]; then
                echo "Copying resolved: $libname"
                cp -f "$resolved" Bitok.app/Contents/Frameworks/
              fi
            fi
          fi
        done

        echo "=== Copying wxWidgets transitive dependencies ==="
        copy_if_missing() {
          local src="$1"
          local name=$(basename "$src")
          if [ ! -f "Bitok.app/Contents/Frameworks/$name" ]; then
            echo "Copying: $name"
            cp -f "$src" Bitok.app/Contents/Frameworks/ 2>/dev/null || true
          fi
        }

        for pkg in libpng libjpeg-turbo jpeg-turbo libtiff pcre2 expat zstd xz webp giflib; do
          pkg_path="$BREW_PREFIX/opt/$pkg/lib"
          if [ -d "$pkg_path" ]; then
            for lib in "$pkg_path"/*.dylib; do
              if [ -f "$lib" ] && [ ! -L "$lib" ]; then
                copy_if_missing "$lib"
              elif [ -L "$lib" ]; then
                resolved=$(readlink -f "$lib" 2>/dev/null || greadlink -f "$lib" 2>/dev/null || echo "")
                if [ -f "$resolved" ]; then
                  targetname=$(basename "$lib")
                  if [ ! -f "Bitok.app/Contents/Frameworks/$targetname" ]; then
                    echo "Copying symlink target as: $targetname"
                    cp -f "$resolved" "Bitok.app/Contents/Frameworks/$targetname"
                  fi
                fi
              fi
            done
          fi
        done

        echo "=== Explicitly handling libjpeg ==="
        for jpeg_path in "$BREW_PREFIX/opt/jpeg-turbo/lib" "$BREW_PREFIX/opt/libjpeg-turbo/lib"; do
          if [ -d "$jpeg_path" ]; then
            for jpeglib in "$jpeg_path"/libjpeg*.dylib; do
              if [ -e "$jpeglib" ]; then
                libname=$(basename "$jpeglib")
                if [ -L "$jpeglib" ]; then
                  resolved=$(readlink -f "$jpeglib" 2>/dev/null || greadlink -f "$jpeglib" 2>/dev/null || echo "")
                  if [ -f "$resolved" ]; then
                    echo "Copying jpeg: $libname"
                    cp -f "$resolved" "Bitok.app/Contents/Frameworks/$libname"
                  fi
                elif [ -f "$jpeglib" ]; then
                  echo "Copying jpeg: $libname"
                  cp -f "$jpeglib" "Bitok.app/Contents/Frameworks/$libname"
                fi
              fi
            done
          fi
        done

        chmod -R u+w Bitok.app/Contents/Frameworks/

        echo "=== Auto-resolving missing dependencies ==="
        APPBIN="Bitok.app/Contents/MacOS/bitok"

        for pass in 1 2 3 4 5; do
          found_new=0
          for target in Bitok.app/Contents/Frameworks/*.dylib "$APPBIN"; do
            if [ -f "$target" ]; then
              deps=$(otool -L "$target" 2>/dev/null | grep -E "/opt/homebrew|/usr/local" | awk '{print $1}' || true)
              for dep in $deps; do
                depname=$(basename "$dep")
                if [ ! -f "Bitok.app/Contents/Frameworks/$depname" ]; then
                  if [ -f "$dep" ]; then
                    echo "Pass $pass: Copying $depname"
                    cp -f "$dep" "Bitok.app/Contents/Frameworks/"
                    chmod u+w "Bitok.app/Contents/Frameworks/$depname"
                    found_new=1
                  elif [ -L "$dep" ]; then
                    resolved=$(readlink -f "$dep" 2>/dev/null || greadlink -f "$dep" 2>/dev/null || echo "")
                    if [ -f "$resolved" ]; then
                      echo "Pass $pass: Copying $depname (resolved)"
                      cp -f "$resolved" "Bitok.app/Contents/Frameworks/$depname"
                      chmod u+w "Bitok.app/Contents/Frameworks/$depname"
                      found_new=1
                    fi
                  fi
                fi
              done
            fi
          done
          [ "$found_new" -eq 0 ] && break
        done

        echo ""
        echo "=== Bundled libraries ==="
        ls -la Bitok.app/Contents/Frameworks/

        echo ""
        echo "=== Fixing all library paths ==="

        fix_paths() {
          local target="$1"
          deps=$(otool -L "$target" 2>/dev/null | tail -n +2 | awk '{print $1}')
          for dep in $deps; do
            if [[ "$dep" == /opt/homebrew/* ]] || [[ "$dep" == /usr/local/* ]]; then
              dep_name=$(basename "$dep")
              if [ -f "Bitok.app/Contents/Frameworks/$dep_name" ]; then
                install_name_tool -change "$dep" "@rpath/$dep_name" "$target" 2>/dev/null || true
              fi
            fi
          done
        }

        for dylib in Bitok.app/Contents/Frameworks/*.dylib; do
          if [ -f "$dylib" ]; then
            libname=$(basename "$dylib")
            install_name_tool -id "@rpath/$libname" "$dylib"
          fi
        done

        for pass in 1 2 3; do
          echo "Fix pass $pass..."
          for dylib in Bitok.app/Contents/Frameworks/*.dylib; do
            [ -f "$dylib" ] && fix_paths "$dylib"
          done
          fix_paths "$APPBIN"
        done

        install_name_tool -add_rpath "@executable_path/../Frameworks" "$APPBIN" 2>/dev/null || true

        echo ""
        echo "=== Checking for remaining Homebrew paths ==="
        ERRORS=0
        for target in Bitok.app/Contents/Frameworks/*.dylib "$APPBIN"; do
          if [ -f "$target" ]; then
            remaining=$(otool -L "$target" 2>/dev/null | grep -E "/opt/homebrew|/usr/local" || true)
            if [ -n "$remaining" ]; then
              echo "WARNING: $(basename $target) has: $remaining"
              ERRORS=1
            fi
          fi
        done

        if [ "$ERRORS" -eq 1 ]; then
          echo ""
          echo "Attempting additional fix passes..."
          for pass in 1 2 3; do
            for target in Bitok.app/Contents/Frameworks/*.dylib "$APPBIN"; do
              if [ -f "$target" ]; then
                deps=$(otool -L "$target" 2>/dev/null | grep -E "/opt/homebrew|/usr/local" | awk '{print $1}' || true)
                for dep in $deps; do
                  dep_name=$(basename "$dep")
                  for candidate in Bitok.app/Contents/Frameworks/*.dylib; do
                    cand_name=$(basename "$candidate")
                    if [[ "$cand_name" == "$dep_name"* ]] || [[ "$dep_name" == "$cand_name"* ]]; then
                      install_name_tool -change "$dep" "@rpath/$cand_name" "$target" 2>/dev/null || true
                    fi
                  done
                done
              fi
            done
          done
        fi

        echo ""
        echo "=== Final verification ==="
        otool -L "$APPBIN" | head -20

    - name: Sign app bundle
      run: |
        set -e
        echo "=== Signing Bitok.app ==="

        echo "Signing frameworks..."
        for dylib in Bitok.app/Contents/Frameworks/*.dylib; do
          if [ -f "$dylib" ]; then
            codesign --force --sign - "$dylib"
          fi
        done

        echo "Signing main executable..."
        codesign --force --sign - Bitok.app/Contents/MacOS/bitok

        echo "Signing app bundle..."
        codesign --force --deep --sign - Bitok.app

        echo "Verifying..."
        codesign --verify --verbose Bitok.app || echo "Warning: verification issue"

        echo "=== Signing completed ==="

    - name: Test GUI app
      run: |
        set -e
        echo "========================================="
        echo "GUI APPLICATION VERIFICATION"
        echo "========================================="

        echo ""
        echo "=== App structure ==="
        ls -la Bitok.app/Contents/
        ls -la Bitok.app/Contents/MacOS/

        echo ""
        echo "=== Binary dependencies ==="
        otool -L Bitok.app/Contents/MacOS/bitok | head -20

        echo ""
        echo "=== Verifying no Homebrew paths ==="
        if otool -L Bitok.app/Contents/MacOS/bitok | grep -E "/opt/homebrew|/usr/local" | grep -v "@rpath"; then
          echo "WARNING: Found unbundled paths"
        else
          echo "OK: No unbundled paths"
        fi

        echo ""
        echo "=== Testing app launch ==="
        timeout 5 ./Bitok.app/Contents/MacOS/bitok --help 2>&1 || {
          code=$?
          if [ "$code" -eq 124 ]; then
            echo "App started (timeout expected in headless mode)"
          else
            echo "Exit code: $code"
          fi
        }

        echo ""
        echo "========================================="
        echo "GUI VERIFICATION COMPLETED"
        echo "========================================="

    - name: Create release packages
      run: |
        VERSION="0.3.19.4"
        ARCH=$(uname -m)

        DAEMON_DIR="bitokd-${VERSION}-macos-${ARCH}"
        mkdir -p "${DAEMON_DIR}/libs"
        cp bitokd "${DAEMON_DIR}/"
        cp libs/*.dylib "${DAEMON_DIR}/libs/"

        printf '%s\n' \
          "Bitok Daemon v0.3.19.4" \
          "" \
          "FIRST TIME SETUP:" \
          "  Run this once after downloading to remove quarantine:" \
          "    xattr -cr /path/to/bitokd-0.3.19.4-macos-*/" \
          "" \
          "Usage:" \
          "  ./bitokd --help          Show help" \
          "  ./bitokd -daemon         Run as daemon" \
          "  ./bitokd -server         Run with RPC server" \
          "" \
          "The daemon uses libraries from the libs/ folder automatically." \
          > "${DAEMON_DIR}/README.txt"

        echo "Signing daemon package..."
        for dylib in "${DAEMON_DIR}/libs/"*.dylib; do
          codesign --force --sign - "$dylib"
        done
        codesign --force --sign - "${DAEMON_DIR}/bitokd"

        tar -czf "${DAEMON_DIR}.tar.gz" "${DAEMON_DIR}"

        GUI_DIR="bitok-${VERSION}-macos-${ARCH}"
        mkdir -p "${GUI_DIR}"
        cp -r Bitok.app "${GUI_DIR}/"

        printf '%s\n' \
          "Bitok GUI v0.3.19.4" \
          "" \
          "FIRST TIME SETUP:" \
          "  Run this once after downloading to remove quarantine:" \
          "    xattr -cr /path/to/bitok-0.3.19.4-macos-*/" \
          "" \
          "Usage:" \
          "  Double-click Bitok.app to launch the wallet GUI." \
          > "${GUI_DIR}/README.txt"

        echo "Re-signing GUI package..."
        for dylib in "${GUI_DIR}/Bitok.app/Contents/Frameworks/"*.dylib; do
          codesign --force --sign - "$dylib"
        done
        codesign --force --sign - "${GUI_DIR}/Bitok.app/Contents/MacOS/bitok"
        codesign --force --deep --sign - "${GUI_DIR}/Bitok.app"

        tar -czf "${GUI_DIR}.tar.gz" "${GUI_DIR}"

        shasum -a 256 "${DAEMON_DIR}.tar.gz" > "${DAEMON_DIR}.tar.gz.sha256"
        shasum -a 256 "${GUI_DIR}.tar.gz" > "${GUI_DIR}.tar.gz.sha256"

        echo "CHECKSUMS for macOS ${ARCH}:" > CHECKSUMS-MACOS.txt
        shasum -a 256 ${DAEMON_DIR}.tar.gz >> CHECKSUMS-MACOS.txt
        shasum -a 256 ${GUI_DIR}.tar.gz >> CHECKSUMS-MACOS.txt

    - name: Test packaged daemon
      run: |
        set -e
        echo "========================================="
        echo "TESTING PACKAGED DAEMON"
        echo "========================================="

        VERSION="0.3.19.4"
        ARCH=$(uname -m)
        DAEMON_DIR="bitokd-${VERSION}-macos-${ARCH}"

        TEST_DIR=$(mktemp -d)
        echo "Extracting to: $TEST_DIR"
        tar -xzf "${DAEMON_DIR}.tar.gz" -C "$TEST_DIR"

        cd "$TEST_DIR/$DAEMON_DIR"

        echo ""
        echo "=== Package contents ==="
        ls -la
        ls -la libs/

        echo ""
        echo "=== Dependencies ==="
        otool -L bitokd | head -15

        echo ""
        echo "=== Testing execution ==="
        if ./bitokd --help 2>&1 | head -5; then
          echo ""
          echo "SUCCESS: Daemon runs correctly"
        else
          echo "FAILED: Daemon execution error"
          DYLD_PRINT_LIBRARIES=1 ./bitokd --help 2>&1 | head -30 || true
          exit 1
        fi

        echo ""
        echo "=== Testing from /tmp ==="
        FULL_PATH="$TEST_DIR/$DAEMON_DIR/bitokd"
        if (cd /tmp && "$FULL_PATH" --help 2>&1 | head -2); then
          echo "SUCCESS: Works from any directory"
        else
          echo "WARNING: Must cd to install directory"
        fi

        cd /
        rm -rf "$TEST_DIR"

        echo ""
        echo "========================================="
        echo "PACKAGED DAEMON TEST PASSED"
        echo "========================================="

    - name: Upload daemon package
      uses: actions/upload-artifact@v4
      with:
        name: bitokd-macos-${{ matrix.arch }}
        path: |
          bitokd-0.3.19.4-macos-*.tar.gz
          bitokd-0.3.19.4-macos-*.tar.gz.sha256

    - name: Upload GUI package
      uses: actions/upload-artifact@v4
      with:
        name: bitok-macos-${{ matrix.arch }}
        path: |
          bitok-0.3.19.4-macos-*.tar.gz
          bitok-0.3.19.4-macos-*.tar.gz.sha256

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums-macos-${{ matrix.arch }}
        path: CHECKSUMS-MACOS.txt
