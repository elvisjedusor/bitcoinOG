# Copyright (c) 2009-2010 Satoshi Nakamoto
# Distributed under the MIT/X11 software license, see the accompanying
# file license.txt or http://www.opensource.org/licenses/mit-license.php.
#
# Bitok: Modernized for macOS 11.0+ (Big Sur and later)
# Supports Apple Silicon (arm64) and Intel (x86_64)

CXX ?= clang++
HOMEBREW_PREFIX ?= $(shell brew --prefix 2>/dev/null || echo /usr/local)

# Architecture - detect native architecture automatically
# Homebrew libraries are architecture-specific, so build for native arch
NATIVE_ARCH := $(shell uname -m)
ARCH ?= $(NATIVE_ARCH)
ARCH_FLAGS = $(foreach arch,$(ARCH),-arch $(arch))

# Compiler flags
# For native builds: make ARCH="arm64" or make ARCH="x86_64" enables -march=native
# For universal binaries: make ARCH="arm64 x86_64" (default, no -march)
# Using -O3 for maximum performance, -fomit-frame-pointer for extra register
CXXFLAGS = -std=c++11 -O3 -fomit-frame-pointer -Wno-invalid-offsetof -Wformat -Wno-deprecated-declarations
CXXFLAGS += -mmacosx-version-min=11.0 $(ARCH_FLAGS)

# Enable native CPU optimizations for single-arch builds
ifeq ($(words $(ARCH)),1)
    CXXFLAGS += -march=native
    NATIVE_OPTS = -march=native
endif

# wxWidgets configuration (for GUI builds)
WXCONFIG ?= $(HOMEBREW_PREFIX)/bin/wx-config
WXCXXFLAGS := $(shell $(WXCONFIG) --cxxflags 2>/dev/null || echo "-DwxUSE_GUI=0")
WXLIBS := $(shell $(WXCONFIG) --libs std 2>/dev/null || echo "")

# Include paths - Homebrew locations
INCLUDEPATHS = \
    -I"$(HOMEBREW_PREFIX)/include" \
    -I"$(HOMEBREW_PREFIX)/opt/openssl@3/include" \
    -I"$(HOMEBREW_PREFIX)/opt/berkeley-db@4/include" \
    -I"."

# Library paths - Homebrew locations
LIBPATHS = \
    -L"$(HOMEBREW_PREFIX)/lib" \
    -L"$(HOMEBREW_PREFIX)/opt/openssl@3/lib" \
    -L"$(HOMEBREW_PREFIX)/opt/berkeley-db@4/lib"

# Libraries for daemon (no GUI)
# Note: Modern Boost (1.69+) made boost_system/filesystem header-only
# Try to link them if available, but don't fail if they're not found
# Use static linking for Berkeley DB to avoid dynamic library path issues
BDB_STATIC = $(HOMEBREW_PREFIX)/opt/berkeley-db@4/lib/libdb_cxx-4.8.a
LIBS_DAEMON = \
    $(BDB_STATIC) \
    -lssl \
    -lcrypto \
    -lpthread

# Check if boost libraries exist and add them if found
BOOST_SYSTEM_EXISTS := $(shell test -e $(HOMEBREW_PREFIX)/lib/libboost_system.dylib -o -e $(HOMEBREW_PREFIX)/lib/libboost_system.a && echo yes)
BOOST_FS_EXISTS := $(shell test -e $(HOMEBREW_PREFIX)/lib/libboost_filesystem.dylib -o -e $(HOMEBREW_PREFIX)/lib/libboost_filesystem.a && echo yes)

ifeq ($(BOOST_SYSTEM_EXISTS),yes)
    LIBS_DAEMON += -lboost_system
endif

ifeq ($(BOOST_FS_EXISTS),yes)
    LIBS_DAEMON += -lboost_filesystem
endif

# Libraries for GUI
LIBS_GUI = $(WXLIBS) $(LIBS_DAEMON)

# Defines
DEFS = -DNOPCH -D_FILE_OFFSET_BITS=64 -DOPENSSL_SUPPRESS_DEPRECATED -DMAC_OSX -DMSG_NOSIGNAL=0
DEFS_GUI = $(DEFS) -DwxUSE_GUI=1
DEFS_DAEMON = $(DEFS) -DwxUSE_GUI=0

# SIMD flags for Intel Macs (Apple Silicon uses different extensions)
# Note: SHA-NI is only available on some Intel processors
SSE41_FLAGS_X86 = -msse4.1
SHANI_FLAGS_X86 = -msse4.1 -msha

# Enable optimized implementations (x86_64 only)
CRYPTO_DEFS = -DENABLE_SSE41 -DENABLE_X86_SHANI

# Headers
HEADERS = headers.h strlcpy.h serialize.h uint256.h util.h key.h bignum.h base58.h \
    script.h bitcoin_db.h db_cxx_compat.h net.h irc.h main.h rpc.h uibase.h ui.h init.h sha.h \
    yespower.h yespower_hash.h sysendian.h

# Crypto object files (optimized SHA256)
OBJS_CRYPTO = \
    obj/crypto/sha256.o \
    obj/crypto/sha256_shani.o

# Yespower object files (ASIC-resistant PoW)
OBJS_YESPOWER = \
    obj/yespower/yespower-opt.o \
    obj/yespower/sha256-yp.o \
    obj/yespower/yespower_dispatch.o

# Object files for GUI
OBJS_GUI = \
    obj/gui/util.o \
    obj/gui/script.o \
    obj/gui/bitcoin_db.o \
    obj/gui/net.o \
    obj/gui/irc.o \
    obj/gui/main.o \
    obj/gui/rpc.o \
    obj/gui/init.o \
    obj/gui/ui.o \
    obj/gui/uibase.o \
    obj/sha.o \
    $(OBJS_CRYPTO) \
    $(OBJS_YESPOWER)

# Object files for daemon
OBJS_DAEMON = \
    obj/nogui/util.o \
    obj/nogui/script.o \
    obj/nogui/bitcoin_db.o \
    obj/nogui/net.o \
    obj/nogui/irc.o \
    obj/nogui/main.o \
    obj/nogui/rpc.o \
    obj/nogui/init.o \
    obj/sha.o \
    $(OBJS_CRYPTO) \
    $(OBJS_YESPOWER)

# Targets
all: bitokd bitok

# Individual targets
daemon: bitokd
gui: bitok

# Daemon version (no GUI)
bitokd: directories $(OBJS_DAEMON)
	$(CXX) $(CXXFLAGS) $(DEFS_DAEMON) -o $@ $(LIBPATHS) $(OBJS_DAEMON) $(LIBS_DAEMON)
	@echo "bitokd built successfully"
	@echo "Fixing dynamic library paths..."
	@install_name_tool -change "$(HOMEBREW_PREFIX)/opt/openssl@3/lib/libssl.3.dylib" "@rpath/libssl.3.dylib" $@ 2>/dev/null || true
	@install_name_tool -change "$(HOMEBREW_PREFIX)/opt/openssl@3/lib/libcrypto.3.dylib" "@rpath/libcrypto.3.dylib" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "@executable_path/libs" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "@executable_path" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "/usr/local/opt/openssl@3/lib" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "$(HOMEBREW_PREFIX)/opt/openssl@3/lib" $@ 2>/dev/null || true

# GUI version (requires wxWidgets)
bitok: directories $(OBJS_GUI)
	$(CXX) $(CXXFLAGS) $(DEFS_GUI) -o $@ $(LIBPATHS) $(OBJS_GUI) $(LIBS_GUI)
	@echo "bitok GUI built successfully"
	@echo "Fixing dynamic library paths..."
	@install_name_tool -change "$(HOMEBREW_PREFIX)/opt/openssl@3/lib/libssl.3.dylib" "@rpath/libssl.3.dylib" $@ 2>/dev/null || true
	@install_name_tool -change "$(HOMEBREW_PREFIX)/opt/openssl@3/lib/libcrypto.3.dylib" "@rpath/libcrypto.3.dylib" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "@executable_path/../Frameworks" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "/usr/local/opt/openssl@3/lib" $@ 2>/dev/null || true
	@install_name_tool -add_rpath "$(HOMEBREW_PREFIX)/opt/openssl@3/lib" $@ 2>/dev/null || true

# Create object directories
directories:
	@mkdir -p obj
	@mkdir -p obj/gui
	@mkdir -p obj/nogui
	@mkdir -p obj/crypto
	@mkdir -p obj/yespower

# GUI object files
obj/gui/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(CXXFLAGS) $(DEFS_GUI) $(WXCXXFLAGS) $(INCLUDEPATHS) -o $@ $<

# Daemon object files (no GUI)
obj/nogui/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(CXXFLAGS) $(DEFS_DAEMON) $(INCLUDEPATHS) -o $@ $<

# SHA optimization (legacy CryptoPP)
obj/sha.o: sha.cpp sha.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(INCLUDEPATHS) -o $@ $<

# Optimized crypto - SHA256 base implementation
# Builds for native architecture (supports both arm64 and x86_64)
obj/crypto/sha256.o: crypto/sha256.cpp crypto/sha256.h crypto/cpuid.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(CRYPTO_DEFS) $(INCLUDEPATHS) -o $@ $<

# Optimized crypto - SHA-NI hardware acceleration (x86_64 Intel only)
# For arm64 builds, this will be built but SHA-NI won't be used at runtime
# Note: -msha flag is required for SHA-NI intrinsics on x86_64
SHANI_COMPILE_FLAGS = $(if $(filter x86_64,$(NATIVE_ARCH)),$(SHANI_FLAGS_X86),)

obj/crypto/sha256_shani.o: crypto/sha256_shani.cpp crypto/sha256.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(CRYPTO_DEFS) $(SHANI_COMPILE_FLAGS) $(INCLUDEPATHS) -o $@ $<

# Yespower - ASIC-resistant proof-of-work algorithm
# AUTO-OPTIMIZED for single-arch builds: Uses -march=native to detect YOUR CPU
# For universal binaries: Uses baseline optimizations for compatibility
# Override with: make YESPOWER_ARCH=x86-64-v3 (for distribution binaries)
YESPOWER_ARCH ?= $(if $(NATIVE_OPTS),native,)
# Aggressive optimization flags for maximum performance
YESPOWER_FLAGS = -O3 -funroll-loops -fomit-frame-pointer -ftree-vectorize $(if $(YESPOWER_ARCH),-march=$(YESPOWER_ARCH))

obj/yespower/yespower-opt.o: yespower-opt.c yespower.h yespower-platform.c sha256.h sysendian.h insecure_memzero.h
	$(CC) -c $(YESPOWER_FLAGS) $(DEFS) $(INCLUDEPATHS) $(ARCH_FLAGS) -o $@ $<

obj/yespower/sha256-yp.o: sha256.c sha256.h
	$(CC) -c $(YESPOWER_FLAGS) $(DEFS) $(INCLUDEPATHS) $(ARCH_FLAGS) -o $@ $<

obj/yespower/yespower_dispatch.o: yespower_dispatch.c yespower_dispatch.h yespower.h
	$(CC) -c $(YESPOWER_FLAGS) $(DEFS) $(INCLUDEPATHS) $(ARCH_FLAGS) -o $@ $<

# Clean
clean:
	-rm -f bitok bitokd
	-rm -rf obj
	-rm -f headers.h.gch
	-rm -rf Bitok.app

# Installation
install: bitokd
	install -m 755 bitokd /usr/local/bin/

install-gui: bitok
	install -m 755 bitok /usr/local/bin/

# Create .app bundle for distribution
bundle: bitok
	@echo "Creating Bitok.app bundle..."
	@mkdir -p Bitok.app/Contents/MacOS
	@mkdir -p Bitok.app/Contents/Resources
	@cp bitok Bitok.app/Contents/MacOS/
	@echo '<?xml version="1.0" encoding="UTF-8"?>' > Bitok.app/Contents/Info.plist
	@echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> Bitok.app/Contents/Info.plist
	@echo '<plist version="1.0">' >> Bitok.app/Contents/Info.plist
	@echo '<dict>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundleExecutable</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>bitok</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundleIdentifier</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>org.bitok.Bitok</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundleName</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>Bitok</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundleVersion</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>0.3.19</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundleShortVersionString</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>0.3.19</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>CFBundlePackageType</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>APPL</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>LSMinimumSystemVersion</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>11.0</string>' >> Bitok.app/Contents/Info.plist
	@echo '  <key>NSHighResolutionCapable</key>' >> Bitok.app/Contents/Info.plist
	@echo '  <string>True</string>' >> Bitok.app/Contents/Info.plist
	@echo '</dict>' >> Bitok.app/Contents/Info.plist
	@echo '</plist>' >> Bitok.app/Contents/Info.plist
	@echo "Bitok.app created successfully"
	@echo "You can now run: open Bitok.app"
	@echo "Or copy to /Applications: cp -r Bitok.app /Applications/"

.PHONY: all daemon gui clean directories install install-gui bundle
