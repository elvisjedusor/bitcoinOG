# Copyright (c) 2009-2010 Satoshi Nakamoto
# Distributed under the MIT/X11 software license, see the accompanying
# file license.txt or http://www.opensource.org/licenses/mit-license.php.
#
# Bitok: Modernized for Ubuntu 24.04 LTS / GCC 11+

CXX ?= g++
# AUTO-OPTIMIZED: -march=native enables all CPU features (AVX2, SSE4.1, etc)
# Using -O3 for maximum performance, -fomit-frame-pointer for extra register
CXXFLAGS = -std=c++11 -O3 -march=native -fomit-frame-pointer -Wno-invalid-offsetof -Wformat -Wno-deprecated-declarations

# wxWidgets configuration (for GUI builds)
WXCONFIG ?= wx-config
WXCXXFLAGS := $(shell $(WXCONFIG) --cxxflags 2>/dev/null || echo "-DwxUSE_GUI=0")
WXLIBS := $(shell $(WXCONFIG) --libs std,html 2>/dev/null || echo "")

# Include paths
INCLUDEPATHS = \
    -I"/usr/include" \
    -I"/usr/local/include" \
    -I"."

# Library paths
LIBPATHS = \
    -L"/usr/lib" \
    -L"/usr/lib/x86_64-linux-gnu" \
    -L"/usr/local/lib"

# Libraries for daemon (no GUI)
# Note: Using db (C API) instead of db_cxx (C++ bindings) for modern compatibility
LIBS_DAEMON = \
    -lboost_system \
    -lboost_filesystem \
    -ldb \
    -lssl \
    -lcrypto \
    -lpthread

# Libraries for GUI (wxWidgets 3.x with GTK3)
LIBS_GUI = $(WXLIBS) $(LIBS_DAEMON)

# Defines
# OPENSSL_SUPPRESS_DEPRECATED - suppress EC_KEY deprecation warnings in OpenSSL 3.x
DEFS = -DNOPCH -D_FILE_OFFSET_BITS=64 -DOPENSSL_SUPPRESS_DEPRECATED
DEFS_GUI = $(DEFS) -DwxUSE_GUI=1
DEFS_DAEMON = $(DEFS) -DwxUSE_GUI=0

# CPU feature detection and SIMD flags
HAVE_SSE41 := $(shell grep -q sse4_1 /proc/cpuinfo 2>/dev/null && echo 1)
HAVE_AVX2 := $(shell grep -q avx2 /proc/cpuinfo 2>/dev/null && echo 1)
HAVE_SHANI := $(shell grep -q sha_ni /proc/cpuinfo 2>/dev/null && echo 1)

# SIMD compiler flags
SSE41_FLAGS = -msse4.1
SHANI_FLAGS = -msse4.1 -msha

# Enable optimized implementations
CRYPTO_DEFS = -DENABLE_SSE41 -DENABLE_X86_SHANI

# Debug flags (comment out for release)
# DEBUGFLAGS = -g -D__WXDEBUG__

HEADERS = headers.h strlcpy.h serialize.h uint256.h util.h key.h bignum.h base58.h \
    script.h bitcoin_db.h db_cxx_compat.h net.h irc.h main.h rpc.h uibase.h ui.h init.h sha.h \
    yespower.h yespower_hash.h sysendian.h

# Crypto object files (optimized SHA256 + Yespower)
OBJS_CRYPTO = \
    obj/crypto/sha256.o \
    obj/crypto/sha256_shani.o

# Yespower object files (ASIC-resistant PoW)
OBJS_YESPOWER = \
    obj/yespower/yespower-opt.o \
    obj/yespower/sha256-yp.o \
    obj/yespower/yespower_dispatch.o

# Object files for GUI
OBJS_GUI = \
    obj/gui/util.o \
    obj/gui/script.o \
    obj/gui/bitcoin_db.o \
    obj/gui/net.o \
    obj/gui/irc.o \
    obj/gui/main.o \
    obj/gui/rpc.o \
    obj/gui/init.o \
    obj/gui/ui.o \
    obj/gui/uibase.o \
    obj/sha.o \
    $(OBJS_CRYPTO) \
    $(OBJS_YESPOWER)

OBJS_DAEMON = \
    obj/nogui/util.o \
    obj/nogui/script.o \
    obj/nogui/bitcoin_db.o \
    obj/nogui/net.o \
    obj/nogui/irc.o \
    obj/nogui/main.o \
    obj/nogui/rpc.o \
    obj/nogui/init.o \
    obj/sha.o \
    $(OBJS_CRYPTO) \
    $(OBJS_YESPOWER)

# Targets
all: bitokd bitok

# Individual targets
daemon: bitokd
gui: bitok

bitok: directories $(OBJS_GUI)
	$(CXX) $(CXXFLAGS) $(DEFS_GUI) -o $@ $(LIBPATHS) $(OBJS_GUI) $(LIBS_GUI)

# Daemon version (no GUI)
bitokd: directories $(OBJS_DAEMON)
	$(CXX) $(CXXFLAGS) $(DEFS_DAEMON) -o $@ $(LIBPATHS) $(OBJS_DAEMON) $(LIBS_DAEMON)

# Create object directories
directories:
	@mkdir -p obj
	@mkdir -p obj/gui
	@mkdir -p obj/nogui
	@mkdir -p obj/crypto
	@mkdir -p obj/yespower

# GUI object files - explicitly set wxUSE_GUI=1
obj/gui/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(CXXFLAGS) $(DEFS_GUI) $(WXCXXFLAGS) $(INCLUDEPATHS) -o $@ $<

# Daemon object files (no GUI)
obj/nogui/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(CXXFLAGS) $(DEFS_DAEMON) $(INCLUDEPATHS) -o $@ $<

# SHA optimization (legacy CryptoPP)
obj/sha.o: sha.cpp sha.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(INCLUDEPATHS) -o $@ $<

# Optimized crypto - SHA256 base implementation
obj/crypto/sha256.o: crypto/sha256.cpp crypto/sha256.h crypto/cpuid.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(CRYPTO_DEFS) $(INCLUDEPATHS) -o $@ $<

# Optimized crypto - SHA-NI hardware acceleration (requires -msha -msse4.1)
obj/crypto/sha256_shani.o: crypto/sha256_shani.cpp crypto/sha256.h
	$(CXX) -c $(CXXFLAGS) -O3 $(DEFS) $(CRYPTO_DEFS) $(SHANI_FLAGS) $(INCLUDEPATHS) -o $@ $<

# JSON Spirit (if needed)
obj/json_spirit_reader.o: json/json_spirit_reader.cpp
	$(CXX) -c $(CXXFLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/json_spirit_value.o: json/json_spirit_value.cpp
	$(CXX) -c $(CXXFLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/json_spirit_writer.o: json/json_spirit_writer.cpp
	$(CXX) -c $(CXXFLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

# Yespower - ASIC-resistant proof-of-work algorithm
# AUTO-OPTIMIZED: Uses -march=native to detect YOUR CPU and enable ALL optimizations
# For distribution binaries: override with YESPOWER_ARCH=x86-64-v3 (works on most CPUs 2015+)
# For old CPUs: override with YESPOWER_ARCH=x86-64 (maximum compatibility)
YESPOWER_ARCH ?= native
# Aggressive optimization flags for maximum performance
# -O3: Maximum optimization
# -funroll-loops: Unroll loops for better performance
# -fomit-frame-pointer: Free up another register for better code generation
# -ftree-vectorize: Enable auto-vectorization (usually on by default with -O3)
# -ffast-math: Faster floating point (safe for Yespower)
YESPOWER_FLAGS = -O3 -funroll-loops -march=$(YESPOWER_ARCH) -fomit-frame-pointer -ftree-vectorize -ffast-math

obj/yespower/yespower-opt.o: yespower-opt.c yespower.h yespower-platform.c sha256.h sysendian.h insecure_memzero.h
	$(CC) -c $(YESPOWER_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/yespower/sha256-yp.o: sha256.c sha256.h
	$(CC) -c $(YESPOWER_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/yespower/yespower_dispatch.o: yespower_dispatch.c yespower_dispatch.h
	$(CC) -c -O2 $(DEFS) $(INCLUDEPATHS) -o $@ $<

clean:
	-rm -f bitok bitokd
	-rm -rf obj
	-rm -f headers.h.gch

# Installation
install: bitokd
	install -m 755 bitokd /usr/local/bin/

install-gui: bitok
	install -m 755 bitok /usr/local/bin/

# =============================================================================
# RELEASE BUILD TARGETS
# =============================================================================
# For distribution binaries that work on most Linux systems (2015+ CPUs)
#
# Usage:
#   make release-daemon    # Static bitokd binary
#   make release-gui       # GUI binary for AppImage
#   make appimage          # Complete AppImage package
#   make release           # Build both daemon and AppImage

# Release architecture: x86-64-v3 works on Intel Haswell+ / AMD Excavator+ (2013+)
# Use x86-64-v2 for older CPUs, or x86-64 for maximum compatibility
RELEASE_ARCH ?= x86-64-v3

# Release compiler flags (optimized, no debug, portable)
RELEASE_CXXFLAGS = -std=c++11 -O3 -march=$(RELEASE_ARCH) -mtune=generic \
    -fomit-frame-pointer -ftree-vectorize \
    -Wno-invalid-offsetof -Wformat -Wno-deprecated-declarations \
    -fno-strict-aliasing -fPIC

# Static libraries for daemon (fully portable binary)
# Requires: libboost-all-dev libdb-dev libssl-dev (static versions)
LIBS_DAEMON_STATIC = \
    -Wl,-Bstatic \
    -lboost_system \
    -lboost_filesystem \
    -ldb \
    -Wl,-Bdynamic \
    -lssl \
    -lcrypto \
    -lpthread \
    -ldl

# Object files for release daemon
OBJS_RELEASE_DAEMON = \
    obj/release/util.o \
    obj/release/script.o \
    obj/release/bitcoin_db.o \
    obj/release/net.o \
    obj/release/irc.o \
    obj/release/main.o \
    obj/release/rpc.o \
    obj/release/init.o \
    obj/release/sha.o \
    obj/release/crypto/sha256.o \
    obj/release/crypto/sha256_shani.o \
    obj/release/yespower/yespower-opt.o \
    obj/release/yespower/sha256-yp.o \
    obj/release/yespower/yespower_dispatch.o

# Object files for release GUI
OBJS_RELEASE_GUI = \
    obj/release-gui/util.o \
    obj/release-gui/script.o \
    obj/release-gui/bitcoin_db.o \
    obj/release-gui/net.o \
    obj/release-gui/irc.o \
    obj/release-gui/main.o \
    obj/release-gui/rpc.o \
    obj/release-gui/init.o \
    obj/release-gui/ui.o \
    obj/release-gui/uibase.o \
    obj/release-gui/sha.o \
    obj/release-gui/crypto/sha256.o \
    obj/release-gui/crypto/sha256_shani.o \
    obj/release-gui/yespower/yespower-opt.o \
    obj/release-gui/yespower/sha256-yp.o \
    obj/release-gui/yespower/yespower_dispatch.o

# Yespower release flags (portable with aggressive optimization)
YESPOWER_RELEASE_FLAGS = -O3 -funroll-loops -march=$(RELEASE_ARCH) -mtune=generic -fomit-frame-pointer -ftree-vectorize -ffast-math

# Create release directories
release-directories:
	@mkdir -p obj/release obj/release/crypto obj/release/yespower
	@mkdir -p obj/release-gui obj/release-gui/crypto obj/release-gui/yespower
	@mkdir -p release

# Release daemon object files
obj/release/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS_DAEMON) $(INCLUDEPATHS) -o $@ $<

obj/release/sha.o: sha.cpp sha.h
	$(CXX) -c $(RELEASE_CXXFLAGS) -O3 $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release/crypto/sha256.o: crypto/sha256.cpp crypto/sha256.h crypto/cpuid.h
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS) $(CRYPTO_DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release/crypto/sha256_shani.o: crypto/sha256_shani.cpp crypto/sha256.h
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS) $(CRYPTO_DEFS) $(SHANI_FLAGS) $(INCLUDEPATHS) -o $@ $<

obj/release/yespower/yespower-opt.o: yespower-opt.c yespower.h yespower-platform.c sha256.h
	$(CC) -c $(YESPOWER_RELEASE_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release/yespower/sha256-yp.o: sha256.c sha256.h
	$(CC) -c $(YESPOWER_RELEASE_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release/yespower/yespower_dispatch.o: yespower_dispatch.c yespower_dispatch.h
	$(CC) -c -O2 -march=$(RELEASE_ARCH) $(DEFS) $(INCLUDEPATHS) -o $@ $<

# Release GUI object files
obj/release-gui/%.o: %.cpp $(HEADERS)
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS_GUI) $(WXCXXFLAGS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/sha.o: sha.cpp sha.h
	$(CXX) -c $(RELEASE_CXXFLAGS) -O3 $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/crypto/sha256.o: crypto/sha256.cpp crypto/sha256.h crypto/cpuid.h
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS) $(CRYPTO_DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/crypto/sha256_shani.o: crypto/sha256_shani.cpp crypto/sha256.h
	$(CXX) -c $(RELEASE_CXXFLAGS) $(DEFS) $(CRYPTO_DEFS) $(SHANI_FLAGS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/yespower/yespower-opt.o: yespower-opt.c yespower.h yespower-platform.c sha256.h
	$(CC) -c $(YESPOWER_RELEASE_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/yespower/sha256-yp.o: sha256.c sha256.h
	$(CC) -c $(YESPOWER_RELEASE_FLAGS) $(DEFS) $(INCLUDEPATHS) -o $@ $<

obj/release-gui/yespower/yespower_dispatch.o: yespower_dispatch.c yespower_dispatch.h
	$(CC) -c -O2 -march=$(RELEASE_ARCH) $(DEFS) $(INCLUDEPATHS) -o $@ $<

# Build static daemon for release
release-daemon: release-directories $(OBJS_RELEASE_DAEMON)
	$(CXX) $(RELEASE_CXXFLAGS) $(DEFS_DAEMON) -o release/bitokd \
		$(LIBPATHS) $(OBJS_RELEASE_DAEMON) $(LIBS_DAEMON_STATIC) \
		-static-libstdc++ -static-libgcc
	strip --strip-all release/bitokd
	@echo "Static daemon built: release/bitokd"
	@ls -lh release/bitokd

# Build GUI for release (dynamic linking for AppImage)
release-gui: release-directories $(OBJS_RELEASE_GUI)
	$(CXX) $(RELEASE_CXXFLAGS) $(DEFS_GUI) -o release/bitok \
		$(LIBPATHS) $(OBJS_RELEASE_GUI) $(LIBS_GUI)
	strip --strip-unneeded release/bitok
	@echo "GUI built: release/bitok"
	@ls -lh release/bitok

# Build AppImage (requires linuxdeploy)
appimage: release-gui
	@echo "Building AppImage..."
	@mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
	@cp release/bitok AppDir/usr/bin/
	@echo "[Desktop Entry]" > AppDir/usr/share/applications/bitok.desktop
	@echo "Type=Application" >> AppDir/usr/share/applications/bitok.desktop
	@echo "Name=Bitok" >> AppDir/usr/share/applications/bitok.desktop
	@echo "Exec=bitok" >> AppDir/usr/share/applications/bitok.desktop
	@echo "Icon=bitok" >> AppDir/usr/share/applications/bitok.desktop
	@echo "Categories=Finance;Network;" >> AppDir/usr/share/applications/bitok.desktop
	@echo "Comment=Bitok Cryptocurrency Wallet" >> AppDir/usr/share/applications/bitok.desktop
	@cp AppDir/usr/share/applications/bitok.desktop AppDir/
	@if [ -f bitok.png ]; then \
		cp bitok.png AppDir/usr/share/icons/hicolor/256x256/apps/; \
		cp bitok.png AppDir/; \
	else \
		echo "Warning: bitok.png not found, AppImage will have no icon"; \
	fi
	@if command -v linuxdeploy >/dev/null 2>&1; then \
		linuxdeploy --appdir AppDir --output appimage; \
		mv Bitok*.AppImage release/ 2>/dev/null || true; \
	elif [ -f ./linuxdeploy-x86_64.AppImage ]; then \
		./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage; \
		mv Bitok*.AppImage release/ 2>/dev/null || true; \
	else \
		echo ""; \
		echo "linuxdeploy not found. To create AppImage:"; \
		echo "  wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"; \
		echo "  chmod +x linuxdeploy-x86_64.AppImage"; \
		echo "  make appimage"; \
	fi
	@echo "AppImage build complete. Check release/ directory."

# Build all release artifacts
release: release-daemon appimage
	@echo ""
	@echo "=== Release build complete ==="
	@ls -lh release/

# Clean release artifacts
clean-release:
	-rm -rf obj/release obj/release-gui
	-rm -rf release AppDir
	-rm -f Bitok*.AppImage

.PHONY: all daemon gui clean directories install install-gui \
        release release-daemon release-gui appimage release-directories clean-release
